<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Interview — Scenarios</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small custom tweaks */
    .modal-backdrop { background: rgba(0,0,0,0.45); }
    .truncate-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <main class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">Scenarios</h1>
        <p class="text-sm text-slate-600">Choose a scenario to start an interview simulation or create a new one.</p>
      </div>
      <div class="flex items-center gap-3">
        <input id="search" type="search" placeholder="Search scenarios..." class="px-3 py-2 border rounded-md shadow-sm w-64" />
        <button id="btnCreate" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700 focus:outline-none">+ Create scenario</button>
      </div>
    </header>

    <section>
      <div id="emptyState" class="hidden text-center py-12 text-slate-500">
        No scenarios yet. Click "Create scenario" to add one.
      </div>

      <ul id="scenarioList" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></ul>
    </section>
  </main>

  <!-- View Scenario Modal -->
  <div id="viewModal" class="fixed inset-0 hidden items-center justify-center z-50" aria-hidden>
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 z-10 overflow-hidden">
      <div class="p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 id="viewTitle" class="text-xl font-bold"></h2>
            <div class="mt-1 flex items-center gap-3 text-sm text-slate-600">
              <span id="viewLang" class="inline-block px-2 py-1 border rounded">Language</span>
              <span id="viewMeta"></span>
              <span id="viewOwner" class="text-slate-500">Owner</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="closeView" class="inline-flex items-center gap-2 px-3 py-2 border rounded-md">Close</button>
          </div>
        </div>

        <div class="mt-4 text-slate-700" id="viewDescription"></div>

        <div class="mt-6 flex items-center justify-end gap-3">
          <button id="btnStart" class="px-4 py-2 bg-emerald-600 text-white rounded-md">Start Scenario</button>
          <button id="btnDuplicate" class="px-3 py-2 border rounded-md">Duplicate</button>
          <button id="btnEditView" class="px-3 py-2 border rounded-md hidden">Edit</button>
          <button id="btnDeleteView" class="px-3 py-2 border rounded-md text-rose-600 hidden">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Scenario Modal -->
  <div id="createModal" class="fixed inset-0 hidden items-center justify-center z-50" aria-hidden>
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-xl mx-4 z-10 overflow-hidden">
      <form id="createForm" class="p-6" autocomplete="off">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold" id="createTitle">Create scenario</h2>
          <button type="button" id="closeCreate" class="px-3 py-2 border rounded-md">Close</button>
        </div>

        <div class="mt-4 grid gap-3">
          <label class="block">
            <div class="text-sm text-slate-700 mb-1">Title</div>
            <input id="title" name="title" required class="w-full px-3 py-2 border rounded-md" placeholder="e.g. Backend Developer — System Design" />
          </label>

          <label class="block">
            <div class="text-sm text-slate-700 mb-1">Language</div>
            <select id="language" name="language" class="w-full px-3 py-2 border rounded-md">
              <option>English</option>
              <option>Thai</option>
              <option>Spanish</option>
            </select>
          </label>

          <label class="block">
            <div class="text-sm text-slate-700 mb-1">Owner</div>
            <input id="owner" name="owner" class="w-full px-3 py-2 border rounded-md" placeholder="Owner name" />
            <div class="text-xs text-slate-500 mt-1">Only the owner can delete or edit the scenario.</div>
          </label>

          <label class="block">
            <div class="text-sm text-slate-700 mb-1">Description</div>
            <textarea id="description" name="description" rows="5" class="w-full px-3 py-2 border rounded-md" placeholder="Describe scenario, interviewer style, topics to cover..."></textarea>
          </label>

          <label class="block">
            <div class="text-sm text-slate-700 mb-1">Tags (comma separated)</div>
            <input id="tags" name="tags" class="w-full px-3 py-2 border rounded-md" placeholder="system design, backend, golang" />
          </label>

          <div class="flex justify-end gap-2 mt-2">
            <button type="button" id="btnCancelCreate" class="px-4 py-2 border rounded-md">Cancel</button>
            <button type="submit" id="btnSubmitCreate" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed right-6 bottom-6 z-50 hidden">
    <div class="bg-slate-800 text-white px-4 py-2 rounded shadow">Saved</div>
  </div>

  <script>
    // --- current user (change this to simulate different users) ---
    const CURRENT_USER = 'Thanachart Sangmola';

    // --- initial sample data ---
    const SAMPLE = [
      {
        id: 'scn-1',
        title: 'Backend Engineer — System Design',
        language: 'English',
        owner: 'Thanachart Sangmola',
        description: 'Simulate a senior backend interview focusing on system design: scalability, databases, caching, and trade-offs. Interviewer is direct and technical.',
        tags: ['system design', 'backend']
      },
      {
        id: 'scn-2',
        title: 'Frontend Engineer — Accessibility',
        language: 'English',
        owner: 'Alice Johnson',
        description: 'Focus on accessibility, component design, and performance. Interviewer asks live coding and asks for progressive enhancement ideas.',
        tags: ['frontend', 'a11y']
      },
      {
        id: 'scn-3',
        title: 'Product Manager — Behavioral',
        language: 'Thai',
        owner: 'Bob Lee',
        description: 'Behavioral interview for a product manager role. Emphasis on communication, prioritization, and stakeholder management.',
        tags: ['behavioral', 'pm']
      }
    ];

    // --- utils ---
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

    // persist in localStorage
    const STORAGE_KEY = 'scenarios.v1';
    function loadScenarios() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return SAMPLE.slice();
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return SAMPLE.slice();
        // ensure owner exists on older items
        return parsed.map(s => ({ ...s, owner: s.owner || CURRENT_USER }));
      } catch (e) {
        console.error('load error', e);
        return SAMPLE.slice();
      }
    }
    function saveScenarios(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    // state
    let scenarios = loadScenarios();
    let filtered = scenarios.slice();

    // DOM refs
    const listEl = $('#scenarioList');
    const emptyEl = $('#emptyState');
    const searchEl = $('#search');

    // modals
    const viewModal = $('#viewModal');
    const createModal = $('#createModal');
    const toastEl = $('#toast');

    // view fields
    const viewTitle = $('#viewTitle');
    const viewLang = $('#viewLang');
    const viewMeta = $('#viewMeta');
    const viewDescription = $('#viewDescription');
    const viewOwner = $('#viewOwner');

    let currentViewed = null;

    // render one scenario card
    function createCard(scn) {
      const li = document.createElement('li');
      li.className = 'bg-white border rounded-lg p-4 shadow-sm flex flex-col';
      li.dataset.id = scn.id;

      const isOwner = scn.owner === CURRENT_USER;

      li.innerHTML = `
        <div class="grow">
          <h3 class="text-lg font-semibold">${escapeHtml(scn.title)}</h3>
          <div class="mt-1 text-xs text-slate-500">Owner: ${escapeHtml(scn.owner)}</div>
          <div class="mt-2 text-sm text-slate-600 truncate-3">${escapeHtml(scn.description)}</div>
        </div>
        <div class="mt-4 flex items-center justify-between gap-3">
          <div class="text-xs text-slate-500">${scn.language} • ${scn.tags ? scn.tags.join(', ') : ''}</div>
          <div class="flex gap-2">
            <button class="btnView px-3 py-1 border rounded-md text-sm">View</button>
            ${isOwner ? '<!-- <button class="btnEdit px-3 py-1 border rounded-md text-sm">Edit</button><button class="btnDelete px-3 py-1 border rounded-md text-sm text-rose-600">Delete</button> -->' : ''}
          </div>
        </div>
      `;

      // attach handlers
      li.querySelector('.btnView').addEventListener('click', () => openViewModal(scn.id));
      const delBtn = li.querySelector('.btnDelete');
      if (delBtn) delBtn.addEventListener('click', () => {
        if (!confirm('Delete this scenario?')) return;
        deleteScenario(scn.id);
      });

      const editBtn = li.querySelector('.btnEdit');
      if (editBtn) editBtn.addEventListener('click', () => openCreateModal(scn, true));

      return li;
    }

    function renderList() {
      listEl.innerHTML = '';
      filtered = applySearch();
      if (!filtered.length) {
        emptyEl.classList.remove('hidden');
        return;
      } else {
        emptyEl.classList.add('hidden');
      }

      const frag = document.createDocumentFragment();
      filtered.forEach(scn => frag.appendChild(createCard(scn)));
      listEl.appendChild(frag);
    }

    // safe HTML escape to avoid injection (very simple)
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // simple search (title, desc, tags)
    function applySearch(){
      const q = (searchEl.value || '').toLowerCase().trim();
      if (!q) return scenarios.slice();
      return scenarios.filter(s => {
        return (
          (s.title && s.title.toLowerCase().includes(q)) ||
          (s.description && s.description.toLowerCase().includes(q)) ||
          (s.tags && s.tags.join(',').toLowerCase().includes(q)) ||
          (s.owner && s.owner.toLowerCase().includes(q))
        );
      });
    }

    // open view modal
    function openViewModal(id) {
      const scn = scenarios.find(s => s.id === id);
      if (!scn) return alert('Scenario not found');
      currentViewed = scn;
      viewTitle.textContent = scn.title;
      viewLang.textContent = scn.language;
      viewMeta.textContent = (scn.tags && scn.tags.length) ? scn.tags.join(' • ') : '';
      viewOwner.textContent = 'Owner: ' + scn.owner;
      viewDescription.textContent = scn.description;

      // permission buttons
      const canModify = scn.owner === CURRENT_USER;
      $('#btnEditView').classList.toggle('hidden', !canModify);
      $('#btnDeleteView').classList.toggle('hidden', !canModify);

      viewModal.classList.remove('hidden');
      viewModal.style.display = 'flex';
      viewModal.setAttribute('aria-hidden', 'false');
      // focus management
      $('#closeView').focus();
    }

    function closeView() {
      viewModal.classList.add('hidden');
      viewModal.style.display = 'none';
      viewModal.setAttribute('aria-hidden', 'true');
      currentViewed = null;
    }

    // Create modal
    function openCreateModal(prefill = null, editing = false) {
      createModal.classList.remove('hidden');
      createModal.style.display = 'flex';
      createModal.setAttribute('aria-hidden', 'false');

      const form = $('#createForm');
      form.dataset.editingId = '';
      form.reset();
      $('#createTitle').textContent = editing ? 'Edit scenario' : 'Create scenario';

      if (prefill) {
        $('#title').value = prefill.title || '';
        $('#language').value = prefill.language || 'English';
        $('#description').value = prefill.description || '';
        $('#tags').value = (prefill.tags||[]).join(', ');
        $('#owner').value = prefill.owner || CURRENT_USER;
        if (editing) form.dataset.editingId = prefill.id;
      } else {
        $('#owner').value = CURRENT_USER;
      }
      $('#title').focus();
    }

    function closeCreate() {
      createModal.classList.add('hidden');
      createModal.style.display = 'none';
      createModal.setAttribute('aria-hidden', 'true');
      const form = $('#createForm');
      form.dataset.editingId = '';
    }

    // create scenario
    function doCreateScenario(data) {
      const id = 'scn-' + Date.now();
      const obj = { id, title: data.title, language: data.language, description: data.description, tags: data.tags, owner: data.owner };
      scenarios.unshift(obj);
      saveScenarios(scenarios);
      renderList();
      showToast('Scenario created');
      closeCreate();
      openViewModal(id);
    }

    function doUpdateScenario(id, data) {
      const idx = scenarios.findIndex(s => s.id === id);
      if (idx === -1) return alert('Not found');
      // only owner can update
      if (scenarios[idx].owner !== CURRENT_USER) return alert('You are not the owner');
      scenarios[idx] = { ...scenarios[idx], title: data.title, language: data.language, description: data.description, tags: data.tags, owner: data.owner };
      saveScenarios(scenarios);
      renderList();
      showToast('Scenario updated');
      closeCreate();
      openViewModal(id);
    }

    // delete
    function deleteScenario(id) {
      const scn = scenarios.find(s => s.id === id);
      if (!scn) return;
      if (scn.owner !== CURRENT_USER) return alert('Only the owner can delete this scenario');
      scenarios = scenarios.filter(s => s.id !== id);
      saveScenarios(scenarios);
      renderList();
      showToast('Deleted');
      closeView();
    }

    // duplicate
    function duplicateCurrent() {
      if (!currentViewed) return;
      // duplicated item becomes owned by the current user
      const prefill = { ...currentViewed, owner: CURRENT_USER };
      openCreateModal(prefill, false);
    }

    // simple toast
    let toastTimer = null;
    function showToast(txt='Saved'){
      clearTimeout(toastTimer);
      toastEl.querySelector('div').textContent = txt;
      toastEl.classList.remove('hidden');
      toastTimer = setTimeout(()=> toastEl.classList.add('hidden'), 2000);
    }

    // start scenario action
    function startScenario() {
      if (!currentViewed) return;
      alert('Starting scenario: ' + currentViewed.title + '\n(Language: ' + currentViewed.language + ')');
      closeView();
    }

    // escape to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!viewModal.classList.contains('hidden')) closeView();
        if (!createModal.classList.contains('hidden')) closeCreate();
      }
    });

    // attach global handlers
    document.addEventListener('click', (e) => {
      // backdrop click
      if (e.target === viewModal) closeView();
      if (e.target === createModal) closeCreate();
    });

    $('#btnCreate').addEventListener('click', () => openCreateModal());
    $('#closeView').addEventListener('click', closeView);
    $('#btnStart').addEventListener('click', startScenario);
    $('#btnDuplicate').addEventListener('click', duplicateCurrent);
    $('#btnEditView').addEventListener('click', () => { if (currentViewed) openCreateModal(currentViewed, true); });
    $('#btnDeleteView').addEventListener('click', () => { if (!currentViewed) return; if (!confirm('Delete this scenario?')) return; deleteScenario(currentViewed.id); });
    $('#closeCreate').addEventListener('click', closeCreate);
    $('#btnCancelCreate').addEventListener('click', closeCreate);

    // form submit (create or update)
    $('#createForm').addEventListener('submit', (ev) => {
      ev.preventDefault();
      const form = ev.currentTarget;
      const editingId = form.dataset.editingId;
      const title = $('#title').value.trim();
      const language = $('#language').value;
      const description = $('#description').value.trim();
      const owner = $('#owner').value.trim() || CURRENT_USER;
      const tags = ($('#tags').value || '').split(',').map(s => s.trim()).filter(Boolean);
      if (!title) return alert('Please give a title');

      if (editingId) {
        doUpdateScenario(editingId, { title, language, description, tags, owner });
      } else {
        doCreateScenario({ title, language, description, tags, owner });
      }
    });

    // search
    searchEl.addEventListener('input', () => renderList());

    // initial render
    renderList();

  </script>
</body>
</html>